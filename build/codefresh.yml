version: '1.0'
mode: parallel

stages: 
- Prepare
- Build
- Test
- Push Dev
- Release

steps:
  
  main_clone:
    stage: Prepare
    title: clone repository
    type: git-clone
    git: cf_github
    repo: ${{CF_REPO_OWNER}}/${{CF_REPO_NAME}}
    revision: ${{CF_BRANCH}}

  prepare_tester_step: &tester
    stage: Prepare
    title: prepare tester step
    image: golang:1.16.3-alpine3.13
    environment:
    - GO111MODULE=on
    - GOCACHE=/codefresh/volume/gocache # change gopath to codefresh shared volume
    - GOPATH=/codefresh/volume/gopath
    commands:
    - go mod download -x
    when:
      steps:
      - name: main_clone
        on:
        - success

  lint:
    <<: *tester
    stage: Test
    title: lint
    commands:
    - make lint
    when:
      steps:
      - name: prepare_tester_step
        on:
        - success

  codegen:
    <<: *tester
    stage: Test
    title: run codegen
    commands:
    - make codegen
    - make check-worktree
    when:
      steps:
      - name: prepare_tester_step
        on:
        - success

  test:
    <<: *tester
    stage: Test
    title: run tests
    commands:
    - make test
    when:
      steps:
      - name: prepare_tester_step
        on:
        - success

  codecov-report:
    stage: Test
    type: codecov-reporter
    title: report code coverage
    arguments:
      codecov_integration: venona
    when:
      steps:
      - name: test
        on:
        - success
  
  build:
    stage: Build
    type: build
    title: build docker image
    image_name: ${{CF_REPO_OWNER}}/${{CF_REPO_NAME}}
    buildkit: true
    disable_push: true
    when:
      steps:
      - name: main_clone
        on:
        - success

    